# Description

The purpose of this repository is to provide scripts that prepare images for training models, that
are intended to generate images as close to them as possible.

The repository contains scripts such as:
* `image_downloader.py` - this script is used to download images from three of the 
most popular anime image galleries: Safebooru, Danbooru and Gelbooru and save them to a selected/created folder.
* `new_image_detect` - this script is used to extract faces from downloaded images and save them to a selected/created folder. 
If you want to fine-tune models using the Dreambooth technique, it is best to practice these models using face images.
* `image_to_text` - this script is used to create descriptions for selected images. 
Dreambooth technique gives better results when texts are added to the exercise in addition to images.
* `main` - this script is used to run other scripts.
* `const` - script with constants.

In the `original_anime90_image` there are taken (resized, background removed, which is currently done manually) 
pictures of 90s style anime characters.

The `ai_image` folder contains examples of images generated by the trained model. 

The images were obtained using the Dreambooth technique.

# Addition

This is a modification of the `train_dreambooth.py` script that allows you to 
use images with descriptions for Dreambooth training.


```python
def __getitem__(self, index):
    example = {}
    instance_image_path = self.instance_images_path[index % self.num_instance_images]

    # Convert PosixPath to string for string operations
    instance_image_path_str = str(instance_image_path)

    # Ensure the file is a valid image
    if not instance_image_path_str.lower().endswith(('.png', '.jpg', '.jpeg')):
        print(f"Skipping non-image file: {instance_image_path_str}")
        return self.__getitem__((index + 1) % len(self.instance_images_path))  # Skip to the next image

    try:
        instance_image = Image.open(instance_image_path)
        instance_image = exif_transpose(instance_image)

        if not instance_image.mode == "RGB":
            instance_image = instance_image.convert("RGB")
        example["instance_images"] = self.image_transforms(instance_image)

        # Load caption from .txt file if it exists
        caption_path = os.path.splitext(instance_image_path_str)[0] + ".txt"
        if os.path.exists(caption_path):
            with open(caption_path, "r", encoding="utf-8") as f:
                caption = f.read().strip()
        else:
            caption = self.instance_prompt  # Fallback to default prompt

        if self.encoder_hidden_states is not None:
            example["instance_prompt_ids"] = self.encoder_hidden_states
        else:
            text_inputs = tokenize_prompt(
                self.tokenizer,  # Positional argument
                caption,         # Positional argument
                tokenizer_max_length=self.tokenizer_max_length  # Keyword argument
            )
            example["instance_prompt_ids"] = text_inputs.input_ids
            example["instance_attention_mask"] = text_inputs.attention_mask

        if self.class_data_root:
            class_image = Image.open(self.class_images_path[index % self.num_class_images])
            class_image = exif_transpose(class_image)

            if not class_image.mode == "RGB":
                class_image = class_image.convert("RGB")
            example["class_images"] = self.image_transforms(class_image)

            if self.class_prompt_encoder_hidden_states is not None:
                example["class_prompt_ids"] = self.class_prompt_encoder_hidden_states
            else:
                class_text_inputs = tokenize_prompt(
                    self.tokenizer,  # Positional argument
                    self.class_prompt,  # Positional argument
                    tokenizer_max_length=self.tokenizer_max_length  # Keyword argument
                )
                example["class_prompt_ids"] = class_text_inputs.input_ids
                example["class_attention_mask"] = class_text_inputs.attention_mask

    except Exception as e:
        raise ValueError(f"Error processing image {instance_image_path_str}: {e}")

    return example
```